{
  "metadata": {
    "id": "kalimba",
    "name": "Kalimba - El Desafío de los 7 Hábitats",
    "description": "Un juego de aventuras épico donde los jugadores avanzan por siete hábitats únicos, enfrentan animales con desafíos de poder y adivinanzas, coleccionan instrumentos mágicos y corazones, y buscan alcanzar el tesoro en la casilla 196.",
    "version": "2.1.1",
    "minPlayers": 2,
    "maxPlayers": 6
  },
  "decisionPoints": [
    {
      "position": 0,
      "requiredField": "pathChoice",
      "prompt": "¿Querés ir por el A (1-14, más corto) o el B (15-35, más largo)?"
    }
  ],
  "stateDisplay": {
    "game": {
      "primary": ["turn", "phase"],
      "secondary": ["lastRoll", "pendingRoll", "currentHabitat"],
      "hidden": ["name"]
    },
    "players": {
      "primary": ["id", "position", "pathChoice"],
      "secondary": ["hearts", "points", "instruments", "items", "skipTurns"],
      "hidden": ["bonusDiceNextTurn", "inverseMode"]
    },
    "board": {
      "primary": ["winPosition", "magicDoorPosition"],
      "secondary": [],
      "hidden": ["pathASquares", "pathBSquares", "moves", "squares", "heartsRequiredForDoor"]
    }
  },
  "initialState": {
    "game": {
      "name": "Kalimba",
      "phase": "SETUP",
      "turn": "p1",
      "playerOrder": ["p1", "p2"],
      "winner": null,
      "lastRoll": 0,
      "pendingRoll": null,
      "currentHabitat": "Inicio"
    },
    "players": {
      "p1": {
        "id": "p1",
        "name": "Player 1",
        "position": 0,
        "hearts": 0,
        "points": 0,
        "items": [],
        "instruments": [],
        "bonusDiceNextTurn": false,
        "pathChoice": null,
        "skipTurns": 0,
        "inverseMode": false
      },
      "p2": {
        "id": "p2",
        "name": "Player 2",
        "position": 0,
        "hearts": 0,
        "points": 0,
        "items": [],
        "instruments": [],
        "bonusDiceNextTurn": false,
        "pathChoice": null,
        "skipTurns": 0,
        "inverseMode": false
      }
    },
    "board": {
      "winPosition": 196,
      "magicDoorPosition": 186,
      "heartsRequiredForDoor": 7,
      "pathASquares": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14],
      "pathBSquares": [15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35],
      "moves": {
        "14": 36,
        "35": 36,
        "45": 82,
        "82": 45,
        "93": 97,
        "141": 165,
        "145": 162
      },
      "squares": {
        "2": {"type": "animal", "name": "Halcón", "power": 3, "points": 3, "habitat": "desierto"},
        "5": {"type": "animal", "name": "Cobra", "power": 4, "points": 4, "habitat": "desierto"},
        "7": {"type": "special", "name": "Águila", "effect": "roll2d6Advance", "power": 3, "points": 3, "habitat": "desierto", "instrument": "flauta del desierto"},
        "11": {"type": "hazard", "name": "Arenas movedizas", "effect": "skipTurn"},
        "16": {"type": "animal", "name": "Escarabajo", "power": 1, "points": 1, "habitat": "desierto", "heart": true},
        "18": {"type": "hazard", "name": "Plantas carnívoras", "effect": "skipTurn"},
        "21": {"type": "animal", "name": "Camello", "power": 2, "points": 2, "habitat": "desierto"},
        "26": {"type": "animal", "name": "Coyote", "power": 2, "points": 2, "habitat": "desierto"},
        "38": {"type": "animal", "name": "Escorpión", "power": 4, "points": 4, "habitat": "desierto"},
        "42": {"type": "animal", "name": "Lobo", "power": 4, "points": 4, "habitat": "bosque"},
        "45": {"type": "portal", "name": "Portal Bosque-Océano", "destination": 82, "inverseMode": "deactivate"},
        "54": {"type": "special", "name": "Zorro dorado", "effect": "jumpToLeader"},
        "55": {"type": "special", "name": "Indios Jíbaros", "effect": "roll2d6Directional"},
        "59": {"type": "animal", "name": "Boa constrictor", "power": 3, "points": 3, "habitat": "bosque", "instrument": "tambor del bosque"},
        "62": {"type": "animal", "name": "Rana venenosa", "power": 2, "points": 2, "habitat": "bosque"},
        "63": {"type": "item", "name": "Traje anti-avispas", "item": "anti-wasp"},
        "64": {"type": "animal", "name": "Oso Grizzly", "power": 4, "points": 4, "habitat": "bosque"},
        "65": {"type": "special", "name": "Murciélagos", "effect": "roll1d6Directional"},
        "66": {"type": "animal", "name": "Ardilla", "power": 1, "points": 1, "habitat": "bosque", "heart": true},
        "68": {"type": "animal", "name": "Ciervo", "power": 2, "points": 2, "habitat": "bosque"},
        "71": {"type": "special", "name": "Pez globo", "effect": "roll2d6Directional"},
        "72": {"type": "animal", "name": "Tiburón tigre", "power": 4, "points": 4, "habitat": "océano"},
        "75": {"type": "special", "name": "Cangrejo", "effect": "roll3d6Directional"},
        "77": {"type": "hazard", "name": "Pirañas", "effect": "checkTorch"},
        "78": {"type": "animal", "name": "Pulpo y estrella de mar", "power": 3, "points": 3, "habitat": "océano"},
        "79": {"type": "item", "name": "Antorcha", "item": "torch"},
        "82": {"type": "portal", "name": "Portal Océano-Bosque", "destination": 45, "inverseMode": "activate"},
        "84": {"type": "animal", "name": "Pez payaso", "power": 1, "points": 1, "habitat": "océano", "heart": true, "instrument": "maracas del océano"},
        "85": {"type": "hazard", "name": "Cae la noche", "effect": "checkTorch"},
        "87": {"type": "animal", "name": "Tortuga marina", "power": 2, "points": 2, "habitat": "océano"},
        "92": {"type": "animal", "name": "Orca Asesina", "power": 4, "points": 4, "habitat": "océano"},
        "95": {"type": "hazard", "name": "Lluvias de meteoritos", "effect": "skipTurn"},
        "97": {"type": "animal", "name": "Pingüino", "power": 2, "points": 2, "habitat": "ártico"},
        "100": {"type": "animal", "name": "Narval", "power": 2, "points": 2, "habitat": "ártico"},
        "101": {"type": "animal", "name": "Morsa", "power": 3, "points": 3, "habitat": "ártico", "instrument": "campanas del ártico"},
        "103": {"type": "special", "name": "Iceberg", "effect": "roll1d6Directional"},
        "105": {"type": "animal", "name": "Oso polar", "power": 4, "points": 4, "habitat": "ártico"},
        "106": {"type": "animal", "name": "Ballena azul", "power": 5, "points": 5, "habitat": "ártico"},
        "109": {"type": "hazard", "name": "Volcán en erupción", "effect": "skipTurn"},
        "114": {"type": "animal", "name": "Fantasma de un babuino", "power": 2, "points": 2, "habitat": "amazonas", "heart": true},
        "115": {"type": "special", "name": "Tornado", "effect": "roll3d6Directional"},
        "116": {"type": "hazard", "name": "Avispas", "effect": "checkAntiWasp"},
        "118": {"type": "animal", "name": "Fantasma de un oso negro", "power": 3, "points": 3, "habitat": "amazonas", "heart": true},
        "119": {"type": "hazard", "name": "Rayo", "effect": "skipTurn"},
        "120": {"type": "animal", "name": "Babuino", "power": 2, "points": 2, "habitat": "amazonas", "instrument": "cascabel del amazonas"},
        "122": {"type": "animal", "name": "Caimán", "power": 3, "points": 3, "habitat": "amazonas"},
        "124": {"type": "animal", "name": "Oso negro", "power": 3, "points": 3, "habitat": "amazonas"},
        "129": {"type": "animal", "name": "Perros salvajes", "power": 2, "points": 2, "habitat": "sabana", "heart": true},
        "131": {"type": "hazard", "name": "Cae la noche", "effect": "checkTorch"},
        "132": {"type": "special", "name": "Avestruz", "effect": "roll2d6Advance", "power": 2, "points": 2, "habitat": "sabana"},
        "133": {"type": "item", "name": "Antorcha", "item": "torch"},
        "134": {"type": "animal", "name": "Cocodrilo", "power": 3, "points": 3, "habitat": "sabana"},
        "136": {"type": "hazard", "name": "Pantano", "effect": "skipTurn"},
        "140": {"type": "animal", "name": "Rinoceronte", "power": 3, "points": 3, "habitat": "sabana"},
        "143": {"type": "hazard", "name": "Remolino", "effect": "skipTurn"},
        "145": {"type": "animal", "name": "Jirafa", "power": 2, "points": 2, "habitat": "sabana"},
        "148": {"type": "animal", "name": "Cocodrilo del Nilo", "power": 3, "points": 3, "habitat": "sabana"},
        "149": {"type": "animal", "name": "León Makulu", "power": 5, "points": 5, "habitat": "sabana"},
        "150": {"type": "animal", "name": "Chita", "power": 3, "points": 3, "habitat": "sabana"},
        "154": {"type": "animal", "name": "Elefante Africano Craig", "power": 4, "points": 4, "habitat": "sabana", "instrument": "cuerno de la sabana"},
        "156": {"type": "animal", "name": "Gorila espalda plateada", "power": 4, "points": 4, "habitat": "sabana", "heart": true},
        "159": {"type": "animal", "name": "Hipopótamo", "power": 3, "points": 3, "habitat": "sabana"},
        "160": {"type": "hazard", "name": "Pirañas", "effect": "skipTurn"},
        "164": {"type": "animal", "name": "Rinoceronte blanco", "power": 4, "points": 4, "habitat": "sabana"},
        "165": {"type": "animal", "name": "Canguro", "power": 2, "points": 2, "habitat": "sabana"},
        "168": {"type": "animal", "name": "Lagartija", "power": 1, "points": 1, "habitat": "india", "heart": true},
        "171": {"type": "animal", "name": "Dragón de Komodo", "power": 3, "points": 3, "habitat": "india"},
        "174": {"type": "hazard", "name": "Cae la noche", "effect": "checkTorch"},
        "176": {"type": "item", "name": "Cimitarra", "item": "scimitar"},
        "178": {"type": "animal", "name": "Elefante Asiático", "power": 4, "points": 4, "habitat": "india"},
        "180": {"type": "animal", "name": "Tigre Shere Khan", "power": 5, "points": 5, "habitat": "india", "instrument": "sitar de la india"},
        "182": {"type": "animal", "name": "Elefante de Tamil Nadu", "power": 4, "points": 4, "habitat": "india"},
        "185": {"type": "animal", "name": "Pavo real", "power": 2, "points": 2, "habitat": "india", "heart": true},
        "186": {"type": "special", "name": "Puerta Mágica", "effect": "magicDoorCheck"},
        "190": {"type": "special", "name": "Calavera", "effect": "returnTo187"},
        "192": {"type": "special", "name": "Calavera", "effect": "returnTo187"},
        "194": {"type": "special", "name": "Calavera", "effect": "returnTo187"},
        "196": {"type": "special", "name": "Corazón de Kalimba", "effect": "win"}
      }
    }
  },
  "rules": {
    "objective": "Be the first player to reach square 196 (the Heart of Kalimba).",
    "mechanics": "**SQUARE TYPES:**\n\n• **animal**: Power check (roll 1d6) → Riddle → Rewards (points, instrument, heart, bonusDiceNextTurn)\n  - Roll < power: FAIL, revert position (orchestrator advances turn)\n  - Roll >= power: SUCCESS, present habitat riddle\n  - Correct answer: points + instrument (if any) + heart (if any) + bonusDiceNextTurn=true\n  - Wrong answer: points only\n\n• **hazard**:\n  - skipTurn: SET skipTurns=1\n  - checkTorch: If has torch, remove it; else skipTurns=1\n  - checkAntiWasp: If has anti-wasp, remove it; else skipTurns=1\n\n• **item**: ADD item to items array (torch, anti-wasp, scimitar)\n\n• **portal**: Auto-handled by system. If destination < current position (backward): SET inverseMode=true. If forward: SET inverseMode=false.\n\n• **special**:\n  - jumpToLeader: Find highest position player, SET current player to that position\n  - roll2d6Advance: Ask player to roll 2d6, ADD result\n  - roll1d6Directional/roll2d6Directional/roll3d6Directional: Roll dice, if inverseMode=false SUBTRACT, if true ADD\n  - magicDoorCheck: Calculate hearts_needed = 7 - hearts - (1 if has scimitar). If <= 0: pass, else block at 186\n  - returnTo187: SET position=187\n  - win: SET winner, phase=FINISHED\n\n**INSTRUMENT SYSTEM:**\n\nBefore each animal encounter, ask if player wants to use an instrument (if they have any).\n- Correct habitat: Auto-pass (skip roll + riddle, collect all rewards automatically)\n- Wrong habitat: +2 bonus to power check roll\n- Single use, remove from instruments array after use\n- Maximum 5 instruments per player\n- 7 habitat-specific instruments: Flauta del Desierto, Tambor del Bosque, Maracas del Océano, Campanas del Ártico, Cascabel del Amazonas, Cuerno de la Sabana, Sitar de la India\n\n**HEARTS SYSTEM:**\n\nHearts are magical points that reduce magic door difficulty. Collected from specific animals and the scimitar item. Current hearts stored in players.X.hearts. Hearts required for magic door: 7 total (hearts + scimitar count as 1 each). Formula: hearts_needed = 7 - player.hearts - (1 if has scimitar else 0).\n\n**RIDDLE SYSTEM:**\n\nDynamically create riddles based on habitat theme (NOT specific animal). Riddle difficulty scales with animal power (1=easy, 6=hard). Always create riddles in Spanish. Accept flexible/creative answers. Habitat themes: desierto (calor, arena, dunas, oasis), bosque (árboles, vida silvestre, sombras), océano (vida marina, profundidades, corrientes), ártico (hielo, frío, glaciares, nieve), amazonas (selva, lluvia, biodiversidad), sabana (pastizales, manadas, depredadores africanos), india (tigres, elefantes, monzones, templos).\n\n**INVERSE MODE:**\n\nPlayer-specific flag (players.X.inverseMode). When true, all directional movement effects reverse (backward becomes forward, forward becomes backward). Only affects roll1d6Directional, roll2d6Directional, and roll3d6Directional squares. Does NOT affect hazards or skip turns. Activates when player teleports backward through portal (82→45). Deactivates when player teleports forward through portal (45→82).\n\n**ITEMS:**\n\n• Antorcha (torch): Prevents skip turn on \"Cae la noche\" hazards. Single use, auto-removed when protecting player.\n• Traje anti-avispas (anti-wasp): Prevents skip turn on \"Avispas\" hazard (square 116). Single use, auto-removed when protecting player.\n• Cimitarra (scimitar): Counts as 1 heart for magic door calculation. Does not occupy instrument slots.",
    "turnStructure": "**PLAYER TURN FLOW:**\n\n1. **PATH CHOICE - MANDATORY FIRST CHECK**:\n   - BEFORE processing ANY turn, check CURRENT STATE: players.X.position = 0 AND players.X.pathChoice = null\n   - If TRUE: Player MUST choose path. Ask: \"¿Querés ir por el A (1-14, más corto) o el B (15-35, más largo)?\"\n   - If FALSE (pathChoice already set to \"A\" or \"B\"): NEVER ask about path again. Proceed to step 2.\n   - **CRITICAL**: Always check current state value of pathChoice before asking. If it's \"A\" or \"B\", skip this step entirely.\n   - **If user announces roll but pathChoice is null**: SET game.pendingRoll to the roll value, ask for path choice, then apply pendingRoll after path is chosen.\n   - **If user says they already chose but pathChoice is still null**: Apologize (\"Disculpá, no lo registré\") and ask again.\n   - **If pendingRoll is set and path is now chosen**: Apply the pendingRoll movement, then SET game.pendingRoll back to null.\n   - Both paths merge at square 36. Do NOT proceed to movement until pathChoice is set.\n\n2. **Check Skip Turns**: If players.X.skipTurns > 0, SUBTRACT 1 from skipTurns, narrate turn loss, STOP processing. Orchestrator will advance turn automatically.\n\n3. **Identify Current Player**: Map game.turn to array index: p1→players.0, p2→players.1, p3→players.2, p4→players.3, p5→players.4, p6→players.5.\n\n4. **Check Bonus Dice**: If players.X.bonusDiceNextTurn = true, expect 2d6 roll (range 2-12). After applying movement, SET bonusDiceNextTurn back to false.\n\n5. **Move Player**: ADD_STATE the roll value to players.X.position. Store old position mentally for potential revert on animal encounter failure.\n\n6. **Auto-teleports**: The system AUTOMATICALLY handles board.moves teleports (portals, path merges, special jumps). You don't check or apply these manually. After teleports, the orchestrator will check for square effects at the destination.\n\n7. **Square Effects - AUTO-HANDLED BY SYSTEM**: The orchestrator AUTOMATICALLY detects when players land on special squares (animals, hazards, items, specials) and will inject the encounter for you to process. When you receive a [SYSTEM: ...] message with square data, process that encounter according to the mechanics section. DO NOT manually check board.squares - the system guarantees you'll be told when encounters happen.\n\n8. **Complete Turn Effects**: Process ALL effects for the current player (movement, encounters, power checks, riddles, rewards). The orchestrator will automatically advance the turn when everything is complete.\n\n9. **Win Check**: If players.X.position >= 196, SET game.winner to player.id and game.phase to \"FINISHED\". Narrate victory.\n\n**CRITICAL**: DO NOT manually change game.turn. The orchestrator automatically advances turns after all effects are complete. Focus on completing the current player's turn fully.",
    "boardLayout": "**BOARD STRUCTURE:**\n\nThe game board has 196 squares with two starting paths that merge into a single path.\n\n**Starting Paths:**\n- Path A: Squares 1-14 (shorter, fewer animals)\n- Path B: Squares 15-35 (longer, more encounters)\n- Both paths converge at square 36\n\n**Key Positions:**\n- Start: Square 0\n- Path merge: Square 36\n- Magic Door: Square 186 (requires hearts to enter)\n- Victory: Square 196 (Corazón de Kalimba)\n\n**Portals:**\n- Square 45 (Portal Bosque-Océano) ↔ Square 82 (Portal Océano-Bosque)\n- Portal 45→82: Teleports forward, deactivates inverse mode\n- Portal 82→45: Teleports backward, activates inverse mode\n\n**Special Teleports (in board.moves):**\n- 14→36: Path A merge\n- 35→36: Path B merge\n- 45→82: Portal forward\n- 82→45: Portal backward\n- 93→97: Arctic zone jump\n- 141→165: Savanna shortcut\n- 145→162: Savanna alternate\n\n**Habitat Zones (approximate ranges):**\n- Desierto (Desert): Squares 1-38\n- Bosque (Forest): Squares 39-71\n- Océano (Ocean): Squares 72-94\n- Ártico (Arctic): Squares 95-110\n- Amazonas (Amazon): Squares 111-127\n- Sabana (Savanna): Squares 128-167\n- India: Squares 168-185\n- Anaconda Path (final stretch): Squares 187-196\n\n**Square Details:** All square-specific data (animals, hazards, items, special effects) is stored in board.squares object with position as key. Reference this for exact square contents.",
    "examples": [
      "User: Quiero el más corto (choosing path) | You: [{ \"action\": \"SET_STATE\", \"path\": \"players.p1.pathChoice\", \"value\": \"A\" }, { \"action\": \"NARRATE\", \"text\": \"Elegiste el Camino A. Ahora tirá el dado, fich.\" }]",
      "User: El más largo (choosing path) | You: [{ \"action\": \"SET_STATE\", \"path\": \"players.p1.pathChoice\", \"value\": \"B\" }, { \"action\": \"NARRATE\", \"text\": \"Elegiste el Camino B. Tirá el dado, fich.\" }]",
      "User: Tiré uno uno (bonusDiceNextTurn=false, repetition, single die 1) | You: [{ \"action\": \"ADD_STATE\", \"path\": \"players.p1.position\", \"value\": 1 }, { \"action\": \"NARRATE\", \"text\": \"Te moviste a la 1.\" }]",
      "User: Tiré dos tres (bonusDiceNextTurn=false, ambiguous) | You: [{ \"action\": \"NARRATE\", \"text\": \"¿Tiraste un 2 o un 3?\" }]",
      "User: Un tres (clarification response) | You: [{ \"action\": \"ADD_STATE\", \"path\": \"players.p1.position\", \"value\": 3 }, { \"action\": \"NARRATE\", \"text\": \"Te moviste a la 3.\" }]",
      "User: Tiré uno uno (bonusDiceNextTurn=true, two dice 1+1=2) | You: [{ \"action\": \"ADD_STATE\", \"path\": \"players.p1.position\", \"value\": 2 }, { \"action\": \"SET_STATE\", \"path\": \"players.p1.bonusDiceNextTurn\", \"value\": false }, { \"action\": \"NARRATE\", \"text\": \"Tiraste 2 dados: 1+1=2. Te moviste a la casilla X.\" }]",
      "User: Tiré un 2 (lands on square 2 - Hawk power 3, player has NO instruments) | You: [{ \"action\": \"ADD_STATE\", \"path\": \"players.p1.position\", \"value\": 2 }, { \"action\": \"NARRATE\", \"text\": \"Casilla 2: Halcón del desierto, poder 3. Tirá un dado para enfrentarlo.\" }]",
      "User: Saqué un 2 (power check fails, orchestrator auto-advances turn) | You: [{ \"action\": \"SET_STATE\", \"path\": \"players.p1.position\", \"value\": 0 }, { \"action\": \"NARRATE\", \"text\": \"Sacaste 2, el halcón tiene poder 3. Fallaste. Volvés a la 0.\", \"soundEffect\": \"hazard\" }]",
      "User: Saqué un 4 (power check success on cobra, riddle pending) | You: [{ \"action\": \"NARRATE\", \"text\": \"¡Bien! Superaste la cobra. Adivinanza del desierto: ¿Qué animal tiene joroba y puede pasar días sin agua?\" }]",
      "User: El camello (correct riddle, complete turn, orchestrator advances) | You: [{ \"action\": \"SET_STATE\", \"path\": \"players.p1.bonusDiceNextTurn\", \"value\": true }, { \"action\": \"ADD_STATE\", \"path\": \"players.p1.points\", \"value\": 4 }, { \"action\": \"NARRATE\", \"text\": \"¡Correcto! 4 puntos. Próximo turno tirás 2 dados.\", \"soundEffect\": \"animal_collect\" }]",
      "User: Uso el tambor del bosque (has instrument in correct habitat) | You: [{ \"action\": \"SET_STATE\", \"path\": \"players.p1.instruments\", \"value\": [] }, { \"action\": \"ADD_STATE\", \"path\": \"players.p1.points\", \"value\": 4 }, { \"action\": \"NARRATE\", \"text\": \"Usaste el tambor en su hábitat. El animal se duerme. Ganaste 4 puntos automáticamente.\", \"soundEffect\": \"animal_collect\" }]"
    ]
  },
  "soundEffects": {
    "animal_collect": "/sounds/animal_collect.wav",
    "item_collect": "/sounds/item_collect.wav",
    "portal": "/sounds/portal.wav",
    "hazard": "/sounds/hazard.wav",
    "victory": "/sounds/victory.wav"
  }
}
